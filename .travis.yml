sudo: required

services:
    - docker

matrix:
    fast_finish: true
    include:
        - env: DOCK=1 IMAGE=bionic PY=2 RUN=unit
          python: 2.7
          os: linux
          dist: trusty

        - env: DOCK=1 IMAGE=bionic PY=3 RUN=unit COVERALLS=1
          python: 3.5
          os: linux
          dist: trusty

        - env: DOCK=1 IMAGE=bionic PY=3 RUN=style
          python: 3.5
          os: linux
          dist: trusty

        - env: DOCK=1 IMAGE=fedora28 PY=2 RUN=unit
          python: 2.7
          os: linux
          dist: trusty

        - env: DOCK=1 IMAGE=fedora28 PY=3 RUN=unit
          python: 3.5
          os: linux
          dist: trusty

        - env: DOCK=1 IMAGE=archlinux PY=2 RUN=unit
          python: 2.7
          os: linux
          dist: trusty

        - env: DOCK=1 IMAGE=archlinux PY=3 RUN=unit
          python: 3.5
          os: linux
          dist: trusty

        - language: generic
          env: RUN=unit PY=2 HOMEBREW_NO_AUTO_UPDATE=1
          os: osx

        - language: generic
          env: RUN=unit PY=3 HOMEBREW_NO_AUTO_UPDATE=1
          os: osx


before_install:
    - echo PATH=$PATH;
    - ./ci/osx_fix_cellar.sh
    - ./ci/osx_fix_rvm.sh
    - ./ci/github_checkout_branch.sh

install:
    - ./ci/docker_build.sh
    - ./ci/osx_get_py3.sh

    # manual get-pip.py on OSX because TLS1.2+ required
    # pyfound.blogspot.com/2017/01/time-to-upgrade-your-python-tls-v12.html
    # and install to virtualenv
    - if [ "${TRAVIS_OS_NAME}" == "osx" ]; then
          curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py;
          if [ "${PY}" == "3" ]; then
              sudo python3 get-pip.py;
          else
              sudo python get-pip.py;
          fi;

          if [ "${PY}" == "3" ]; then
              pip3 install --user virtualenv;
              python3 -m virtualenv env;
          else
              pip install --user virtualenv;
              python -m virtualenv env;
          fi;

          source env/bin/activate;
          pip install --upgrade --requirement devrequirements.txt;
          pip install https://github.com/kivy/pyobjus/zipball/master;
      fi;


script:
    # run containers from images
    - if [ "${TRAVIS_OS_NAME}" == "linux" ] && [ -v DOCK ]; then
          if [ "$PY" == "2" ] && [ "$RUN" == "unit" ]; then
              docker run
                  --interactive
                  --tty
                  plyer:py2;

          elif [ "$PY" == "3" ] && [ "$RUN" == "unit" ]; then
              if [ "${COVERALLS}" == "1" ]; then
                  docker run
                      --interactive
                      --tty
                      --env COVERALLS_REPO_TOKEN=$COVERALLS_REPO_TOKEN
                      --env COVERALLS_SERVICE_NAME=travis-ci
                      --env TRAVIS_JOB_ID=$TRAVIS_JOB_ID
                      --env TRAVIS_PULL_REQUEST=$TRAVIS_PULL_REQUEST
                      --env PLYER_DEPLOY=${PLYER_DEPLOY:-"0"}
                      --env TWINE_REPOSITORY=$TWINE_REPOSITORY
                      --env TWINE_REPOSITORY_URL=$TWINE_REPOSITORY_URL
                      --env TWINE_USERNAME=$TWINE_USERNAME
                      --env TWINE_PASSWORD=$TWINE_PASSWORD
                      plyer:py3;

              else
                  docker run
                      --interactive
                      --tty
                      plyer:py3;
              fi;

          elif [ "$PY" == "3" ] && [ "$RUN" == "style" ]; then
              docker run
                  --interactive
                  --tty
                  plyer:style;
          fi;
        fi;

    # test_facade.py fails to reload modules when run
    # on Travis OSX images in Py3 yet works properly
    # on Windows, Linux and OSX devices
    - if [ "${TRAVIS_OS_NAME}" == "osx" ]; then
          pip install --editable .;
          nosetests
              --stop
              --nocapture
              ./plyer/tests;
      fi;
